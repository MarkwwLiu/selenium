# CLAUDE.md — AI 開發規範

本檔案定義 AI（Claude）在此專案中的開發流程與行為規範。

---

## 開發流程

每次收到新需求，必須嚴格按照以下流程執行：

```
需求 → 開分支 → 規劃 → 開發 → Code Review → 測試 → User Review → Merge
```

### 流程細節

```
┌──────────────┐
│  收到新需求    │
└──────┬───────┘
       ▼
┌──────────────┐
│  建立功能分支   │  git checkout -b claude/<feature-name>
└──────┬───────┘
       ▼
┌──────────────┐
│  規劃需求      │  列出要做什麼、影響哪些檔案、預期結果
└──────┬───────┘
       ▼
┌──────────────┐
│  開始開發      │  遵守：維護性、擴充性、可讀性
└──────┬───────┘
       ▼
┌──────────────┐
│  Code Review  │  自我檢查程式碼品質
└──────┬───────┘
       ▼
┌──────────────┐
│  跑測試       │  pytest tests/unit/ -v（至少 unit test）
└──────┬───────┘
       ▼
┌──────────────┐
│  請 User Review│  提交給使用者審查
└──────┬───────┘
       ▼
   ┌───┴───┐
   │ 同意？  │
   └───┬───┘
  Yes  │  No
   ▼   │   ▼
┌─────┐│┌──────────────┐
│Merge││ │ 繼續開發+測試  │──→ 回到「開始開發」
│to   │││              │
│main ││└──────────────┘
└─────┘│
```

---

## 程式碼品質原則

每次寫程式碼都必須遵守：

1. **維護性** — 結構清晰，改一個地方不會牽連其他地方
2. **擴充性** — 容易加新功能，不需要大幅改動既有程式碼
3. **可讀性** — 命名清楚、邏輯簡潔，別人看得懂

---

## Code Review 檢查清單

提交前自我檢查：

- [ ] 命名有意義（變數、函式、類別）
- [ ] 沒有重複的程式碼
- [ ] 沒有寫死的值（magic number / hardcoded string）
- [ ] 錯誤處理完整
- [ ] 有遵循既有的程式碼風格
- [ ] 新增的功能有對應的測試
- [ ] 不影響既有功能（沒有 breaking change）

---

## 測試規範

- **每次開發完成必須跑測試**，至少跑 `pytest tests/unit/ -v`
- 測試必須全部通過才能請 User Review
- 如果有修改核心模組（`pages/`、`utils/`、`config/`），必須確認所有 unit test 通過

---

## AI 實作測試的規範

當 AI 被要求實作測試案例時，必須遵守以下規則：

### 1. 開始前：確認需求

- 提供使用者需要的**選項**（測試類型、瀏覽器、環境等）
- 確認**數量**（要產生多少測試案例）
- 收集**必要資訊**（目標 URL、帳密、特殊邏輯）

### 2. 實作中：自己跑、自己修

- AI 必須**自己執行測試**，不能只寫完就交差
- 如果測試失敗，AI 必須**重新思考並修復**
- **至少 retry 3 次**，不能跑一次失敗就回報使用者
- 每次 retry 要分析失敗原因，不是盲目重跑

### 3. 完成後：按流程走

- 測試全部通過後，按照上面的開發流程走：
  - Commit → Code Review → 跑測試 → 請 User Review
- **不能在測試沒過的情況下回報「完成」**

### Retry 流程

```
寫測試 → 跑測試 → 失敗？
                    │
              Yes   │   No → 提交
                    ▼
              分析失敗原因
                    │
                    ▼
              修改程式碼
                    │
                    ▼
              再跑測試 → 失敗？（重複最多 3 次）
                              │
                         仍然失敗 → 回報使用者，說明問題和已嘗試的方法
```

---

## 分支命名規範

- 功能分支：`claude/<feature-name>`
- 修復分支：`claude/fix-<issue-name>`
- 文件分支：`claude/docs-<topic>`

---

## Commit 規範

```
<type>: <簡短描述>

<詳細說明（可選）>
```

Type：
- `feat`: 新功能
- `fix`: 修復 bug
- `refactor`: 重構（不改功能）
- `test`: 新增或修改測試
- `docs`: 文件更新
- `chore`: 雜項（設定、依賴等）

---

## 專案結構規則

- **核心不動** — `pages/`、`utils/`、`config/` 是基礎架構，修改需謹慎
- **情境獨立** — 每個測試任務在 `scenarios/<name>/` 下，互不干擾
- **新增工具** — 放在 `utils/`，並在 `conftest.py` 加上 fixture
- **新增頁面** — 繼承 `BasePage`，放在對應情境的 `pages/`
